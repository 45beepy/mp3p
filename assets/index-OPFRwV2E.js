(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function r(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(i){if(i.ep)return;i.ep=!0;const a=r(i);fetch(i.href,a)}})();const V="AIzaSyD53qoAMqp4Wu9nHSyaBbCzUn1j0gYK5Cw",W="957252189604-cfmbh7s2rjbpbql8rcsrlc3bpu6m2cq5.apps.googleusercontent.com",X="https://www.googleapis.com/auth/drive.readonly",O="mp3p_music",A="https://i.pinimg.com/1200x/4a/86/34/4a86344f69940e6b166c0bcbde36c3bc.jpg",M="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";let e={token:sessionStorage.getItem("g_token"),rootId:null,albums:[],tracks:[],covers:{},trackCache:{},coverBlobCache:{},durationCache:{},albumColors:{},albumLogos:{},lyricsCache:{},syncedLyricsCache:{},playlist:[],currentIndex:-1,currentAlbum:null,playingFileId:null,playingAlbumId:null,isPlaying:!1,blobUrl:null,isLoadingTrack:!1,currentLyrics:[],currentLyricIndex:-1,currentTrackLyrics:{plain:null,synced:null},lyricsCurtainOpen:!1,searchQuery:""},y=null,S=null;const J=document.querySelector("#app");J.innerHTML=`
  <header id="main-header">
    <div class="header-left">
      <button id="back-btn" class="secondary" style="display:none;">BACK</button>
      <h1 id="page-title">MP3P</h1>
    </div>
    <div class="header-center">
      <div id="search-container" style="display:none;">
        <input type="text" id="search-input" placeholder="Search albums..." />
        <button id="clear-search">✕</button>
      </div>
    </div>
    <div class="header-right">
        <button id="search-btn" title="Search Albums">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
        <button id="auth-btn">SYNC</button>
    </div>
  </header>
  
  <div id="main-view">
    <div style="padding:50px; text-align:center; color:#666; font-weight:700;">
      TAP <span style="color:#000; background:var(--yellow); padding:2px 6px;">SYNC</span> TO LOAD LIBRARY<br><br>
      (READING FOLDER: "${O}")
    </div>
  </div>

  <div id="lyrics-curtain" class="lyrics-curtain-mini">
    <div class="lyrics-curtain-content">
      <p class="lyrics-placeholder">No track playing</p>
    </div>
  </div>

  <button class="lyrics-toggle-btn-mini" id="btn-lyrics-toggle" style="display:none;" title="Show/Hide Lyrics">
    <span class="arrow-icon-mini">››</span>
  </button>

  <div id="player-bar">
    <div class="p-art-box">
      <img id="p-art" class="p-art" src="${M}">
    </div>

    <div class="p-center">
      <div class="p-track-info">
        <span id="p-title" class="p-title">NOT PLAYING</span>
        <span id="p-artist" class="p-artist">SELECT A TRACK</span>
      </div>
      <div class="p-scrubber" id="p-scrubber">
        <div class="p-bar-bg" id="p-bar-bg">
          <div class="p-bar-fill" id="p-bar-fill"></div>
        </div>
      </div>
    </div>

    <div class="p-controls">
      <button class="ctrl-btn" id="btn-prev">⏮</button>
      <button class="ctrl-btn play-btn" id="btn-play">▶</button>
      <button class="ctrl-btn" id="btn-next">⏭</button>
    </div>
  </div>
  
  <audio id="audio-engine"></audio>
`;const j=document.getElementById("main-header"),m=document.getElementById("main-view"),R=document.getElementById("back-btn"),u=document.getElementById("page-title"),o=document.getElementById("audio-engine");o.preload="auto";o.playsInline=!0;y=new Audio;y.preload="auto";y.playsInline=!0;y.muted=!0;y.style.display="none";document.body.appendChild(y);const B=document.getElementById("p-title"),w=document.getElementById("p-artist"),k=document.getElementById("p-art"),b=document.getElementById("btn-play"),Z=document.getElementById("btn-next"),ee=document.getElementById("btn-prev"),$=document.getElementById("btn-lyrics-toggle"),te=document.getElementById("p-scrubber"),ne=document.getElementById("p-bar-bg"),re=document.getElementById("p-bar-fill"),F=document.getElementById("lyrics-curtain"),ie=document.getElementById("search-btn"),T=document.getElementById("search-container"),I=document.getElementById("search-input"),ce=document.getElementById("clear-search");k.onerror=()=>{k.src!==A&&(k.src=A)};$.onclick=()=>{e.lyricsCurtainOpen=!e.lyricsCurtainOpen,e.lyricsCurtainOpen?(F.classList.add("open"),$.classList.add("active"),z(e.currentTrackLyrics)):(F.classList.remove("open"),$.classList.remove("active"))};ie.onclick=()=>{const n=T.style.display!=="none";T.style.display=n?"none":"flex",n?(e.searchQuery="",I.value="",C()):I.focus()};I.oninput=n=>{e.searchQuery=n.target.value.toLowerCase(),C()};ce.onclick=()=>{e.searchQuery="",I.value="",T.style.display="none",C()};function L(n){const t=n.replace(/\.[^/.]+$/,""),r=[/^(\d+)\.\s*/,/^(\d+)\s*-\s*/,/^(\d+)_\s*/,/^(\d+)\s+/];for(const c of r){const i=t.match(c);if(i){const a=parseInt(i[1],10),s=t.replace(c,"").trim();return{number:a,cleanName:s}}}return{number:999,cleanName:t}}function ae(n){const t=n.split(`
`),r=[];for(const c of t){const i=c.match(/^\[(\d+):(\d+)\.(\d+)\](.*)$/);if(i){const a=parseInt(i[1],10),s=parseInt(i[2],10),l=parseInt(i[3],10),d=i[4].trim(),f=a*60+s+l/100;d.length>0&&r.push({time:f,text:d})}}return r}async function K(n){if(e.albumColors[n])return e.albumColors[n];try{const t=await gapi.client.drive.files.list({q:`name = 'colors.txt' and '${n}' in parents and trashed = false`,fields:"files(id)",pageSize:1});if(!t.result.files||t.result.files.length===0)return null;const r=t.result.files[0].id,c=await fetch(`https://www.googleapis.com/drive/v3/files/${r}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!c.ok)return null;const i=await c.text(),a=i.match(/font:\s*([#\w]+)/i),s=i.match(/line:\s*([#\w]+)/i),l=i.match(/titleBg:\s*([#\w]+)/i),d=i.match(/titleText:\s*([#\w]+)/i),f=i.match(/logo:\s*([^\r\n]+)/i);if(a&&s&&l&&d){const p={font:a[1].trim(),line:s[1].trim(),titleBg:l[1].trim(),titleText:d[1].trim(),logo:f?f[1].trim():void 0};return e.albumColors[n]=p,p.logo&&await se(n,p.logo),p}return null}catch(t){return console.error("Error loading album colors:",t),null}}async function se(n,t){try{const r=await gapi.client.drive.files.list({q:`name = '${t}' and '${n}' in parents and trashed = false`,fields:"files(id)",pageSize:1});if(!r.result.files||r.result.files.length===0)return;const c=r.result.files[0].id,i=await fetch(`https://www.googleapis.com/drive/v3/files/${c}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!i.ok)return;const a=await i.blob(),s=URL.createObjectURL(a);e.albumLogos[n]=s}catch(r){console.error("Error loading album logo:",r)}}async function oe(n,t,r){const c=`${t}-${r}-${n}`;if(e.syncedLyricsCache[c])return{plain:null,synced:e.syncedLyricsCache[c]};if(e.lyricsCache[c])return{plain:e.lyricsCache[c],synced:null};try{const i=`https://lrclib.net/api/search?track_name=${encodeURIComponent(n)}`,a=await fetch(i,{headers:{"User-Agent":"MP3P Music Player v1.0"}});if(!a.ok)return{plain:null,synced:null};const s=await a.json();if(!s||s.length===0)return{plain:null,synced:null};let l=s[0];for(const d of s)if(d.albumName&&r&&d.albumName.toLowerCase().includes(r.toLowerCase())){l=d;break}if(l===s[0]){for(const d of s)if(d.artistName&&r&&d.artistName.toLowerCase().includes(r.toLowerCase())){l=d;break}}if(l.syncedLyrics){const d=ae(l.syncedLyrics);return e.syncedLyricsCache[c]=d,{plain:null,synced:d}}else if(l.plainLyrics)return e.lyricsCache[c]=l.plainLyrics,{plain:l.plainLyrics,synced:null};return{plain:null,synced:null}}catch{return{plain:null,synced:null}}}async function le(n){if(!e.currentAlbum)return{plain:null,synced:null};const{cleanName:t}=L(n),r=e.currentAlbum.name,c=e.currentAlbum.name;return await oe(t,r,c)}function _(n){const t=document.querySelector(".lyrics-content");if(t)if(n.synced&&n.synced.length>0){e.currentLyrics=n.synced,e.currentLyricIndex=-1;const r=n.synced.map((c,i)=>{const a=c.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return`<p class="lyric-line" data-index="${i}" data-time="${c.time}">${a}</p>`}).join("");t.innerHTML=r}else if(n.plain){e.currentLyrics=[],e.currentLyricIndex=-1;const c=n.plain.split(`
`).map(i=>{const a=i.trim();return a===""?"<p><br></p>":`<p>${a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>`}).join("");t.innerHTML=c}else t.innerHTML='<p class="lyrics-placeholder">No lyrics available for this track</p>'}function z(n){const t=document.querySelector(".lyrics-curtain-content");if(t)if(n.synced&&n.synced.length>0){const r=n.synced.map((c,i)=>{const a=c.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return`<p class="lyric-line-curtain" data-index="${i}" data-time="${c.time}">${a}</p>`}).join("");t.innerHTML=r}else if(n.plain){const c=n.plain.split(`
`).map(i=>{const a=i.trim();return a===""?"<p><br></p>":`<p>${a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>`}).join("");t.innerHTML=c}else t.innerHTML='<p class="lyrics-placeholder">No lyrics available for this track</p>'}function de(n){if(e.currentLyrics.length===0)return;let t=-1;for(let i=e.currentLyrics.length-1;i>=0;i--)if(n>=e.currentLyrics[i].time){t=i;break}if(t===e.currentLyricIndex)return;e.currentLyricIndex=t;const r=document.querySelector(".lyrics-content");r&&r.querySelectorAll(".lyric-line").forEach((a,s)=>{s===t?(a.classList.add("active"),a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("active")});const c=document.querySelector(".lyrics-curtain-content");c&&e.lyricsCurtainOpen&&c.querySelectorAll(".lyric-line-curtain").forEach((a,s)=>{s===t?(a.classList.add("active"),a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("active")})}function ue(n){const t=e.albumColors[n];document.querySelectorAll(".album-title.playing").forEach(r=>{const c=r;t?(c.style.color=t.font,c.style.borderBottomColor=t.line):(c.style.color="",c.style.borderBottomColor="")})}function pe(n){const t=e.albumColors[n],r=e.albumLogos[n];t?(u.style.backgroundColor=t.titleBg,u.style.color=t.titleText,r?(u.classList.add("has-logo"),u.style.backgroundImage=`url("${r}")`,u.setAttribute("aria-label",u.textContent||"")):(u.classList.remove("has-logo"),u.style.backgroundImage="")):(u.classList.remove("has-logo"),u.style.backgroundColor="",u.style.color="",u.style.backgroundImage="")}function me(n){const t=e.albumColors[n];t?(b.style.backgroundColor=t.font,b.style.color=t.titleText):(b.style.backgroundColor="",b.style.color="")}function G(){u.classList.remove("has-logo"),u.style.backgroundColor="",u.style.color="",u.style.backgroundImage=""}function ye(){b.style.backgroundColor="",b.style.color=""}async function q(n,t){if(e.durationCache[n]){const r=document.querySelector(`[data-index="${t}"]`);r&&(r.textContent=e.durationCache[n]);return}try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${n}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Range:"bytes=0-204800"}});if(!r.ok)return;const c=await r.blob(),i=URL.createObjectURL(c),a=new Audio(i);await new Promise((s,l)=>{const d=setTimeout(()=>{a.removeEventListener("loadedmetadata",f),a.removeEventListener("error",p),URL.revokeObjectURL(i),l(new Error("Timeout"))},5e3),f=()=>{clearTimeout(d);const g=a.duration;if(g&&isFinite(g)){const v=Math.floor(g/60),D=Math.floor(g%60),E=`${v}:${D.toString().padStart(2,"0")}`;e.durationCache[n]=E;const x=document.querySelector(`[data-index="${t}"]`);x&&(x.textContent=E)}URL.revokeObjectURL(i),s()},p=()=>{clearTimeout(d),URL.revokeObjectURL(i),l(new Error("Load error"))};a.addEventListener("loadedmetadata",f),a.addEventListener("error",p)})}catch(r){console.error(`Failed to load duration for file ${n}:`,r)}}function fe(){const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.onload=he,document.body.append(n);const t=document.createElement("script");t.src="https://apis.google.com/js/api.js",t.onload=()=>gapi.load("client",ge),document.body.append(t)}async function ge(){await gapi.client.init({apiKey:V,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),e.token&&Y()}function he(){const n=google.accounts.oauth2.initTokenClient({client_id:W,scope:X,callback:t=>{t.error||(e.token=t.access_token,sessionStorage.setItem("g_token",t.access_token),Y())}});document.getElementById("auth-btn").onclick=()=>n.requestAccessToken({prompt:""}),R.onclick=()=>{T.style.display="none",e.searchQuery="",I.value="",G(),C()}}async function P(n,t){let r=[],c=null;do{const i=await gapi.client.drive.files.list({q:n,fields:`nextPageToken, files(${t})`,pageSize:1e3,pageToken:c});i.result.files&&(r=r.concat(i.result.files)),c=i.result.nextPageToken}while(c);return r}async function H(n,t){if(e.coverBlobCache[t]){n.src=e.coverBlobCache[t];return}try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!r.ok)throw new Error;const c=await r.blob(),i=URL.createObjectURL(c);e.coverBlobCache[t]=i,n.src=i}catch{n.src=A}}async function Y(){if(e.token){gapi.client.setToken({access_token:e.token}),e.trackCache={},e.coverBlobCache={};try{m.innerHTML=`<div style="text-align:center; padding:50px; color:#666; font-weight:700;">SCANNING "${O}"...</div>`;const n=await gapi.client.drive.files.list({pageSize:1,fields:"files(id)",q:`name = '${O}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`});if(e.rootId=n.result.files?.[0]?.id,!e.rootId){m.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow); font-weight:700;">FOLDER NOT FOUND</div>';return}e.albums=await P(`'${e.rootId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,"id, name");const t=await P("name = 'folder.jpg' and trashed = false","id, parents");e.covers={},t.forEach(r=>{r.parents?.[0]&&(e.covers[r.parents[0]]=r.id)}),C()}catch{m.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow);">CONNECTION FAILED<br>TRY RESET</div>'}}}function C(){if(R.style.display="none",j.classList.remove("album-mode"),u.innerText="MP3P",e.albums.length===0){m.innerHTML='<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS FOUND</div>';return}const n=e.searchQuery?e.albums.filter(r=>r.name.toLowerCase().includes(e.searchQuery)):e.albums;if(n.length===0){m.innerHTML=`<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS MATCH "${e.searchQuery}"</div>`;return}const t=document.createElement("div");t.className="grid",n.forEach(r=>{const c=e.covers[r.id],i=document.createElement("div");i.className="album-card";const a=r.id===e.playingAlbumId?"album-title playing":"album-title";i.innerHTML=`<img class="album-cover" src="${M}"><div class="${a}">${r.name}</div>`;const s=i.querySelector("img");c?H(s,c):s.src=A,i.onclick=()=>be(r),t.appendChild(i)}),m.innerHTML="",m.appendChild(t),e.playingAlbumId&&ue(e.playingAlbumId)}async function be(n){if(e.currentAlbum=n,R.style.display="block",j.classList.add("album-mode"),u.innerText=n.name.toUpperCase(),T.style.display="none",await K(n.id)?pe(n.id):G(),e.trackCache[n.id]){e.tracks=e.trackCache[n.id],U();return}m.innerHTML='<div style="text-align:center; padding:50px; color:#666; font-weight:700;">LOADING TRACKS...</div>';try{e.tracks=await P(`'${n.id}' in parents and (mimeType contains 'audio/') and trashed = false`,"id, name, mimeType, size"),e.tracks.sort((r,c)=>{const i=L(r.name),a=L(c.name);return i.number-a.number}),e.trackCache[n.id]=e.tracks,U()}catch{m.innerHTML="ERROR LOADING TRACKS"}}function U(){if(window.innerWidth>768){const t=document.createElement("div");t.className="album-view-desktop";const r=document.createElement("div");r.className="album-left";const c=document.createElement("div");c.className="album-art-large";const i=document.createElement("img");i.src=M;const a=e.currentAlbum&&e.covers[e.currentAlbum.id];a?H(i,a):i.src=A,c.appendChild(i);const s=document.createElement("div");s.className="album-info",s.innerHTML=`
      <h2>${e.currentAlbum?.name||"Unknown Album"}</h2>
      <p class="track-count">${e.tracks.length} tracks</p>
    `,r.appendChild(c),r.appendChild(s);const l=document.createElement("div");l.className="album-middle";const d=document.createElement("div");d.className="track-list-compact",e.tracks.forEach((p,g)=>{const v=document.createElement("div");v.className="track-row",p.id===e.playingFileId&&v.classList.add("active");const E=p.name.split(".").pop()?.toUpperCase()||"AUDIO",{cleanName:x}=L(p.name),Q=e.durationCache[p.id]||"--:--";v.innerHTML=`
          <div class="track-left">
              <div class="track-num">${g+1}</div>
              <div class="track-info">
                  <div class="track-name">${x}</div>
              </div>
          </div>
          <div class="track-right">
              <span class="track-tech tech-ext">${E}</span>
              <span class="track-tech track-duration" data-index="${g}">${Q}</span>
          </div>
      `,v.onclick=()=>h(g),d.appendChild(v),e.durationCache[p.id]||q(p.id,g)}),l.appendChild(d);const f=document.createElement("div");f.className="album-right",f.id="lyrics-panel",f.innerHTML=`
      <div class="lyrics-header">LYRICS</div>
      <div class="lyrics-content">
        <p class="lyrics-placeholder">Select a track to view lyrics</p>
      </div>
    `,(e.currentTrackLyrics.plain||e.currentTrackLyrics.synced)&&setTimeout(()=>_(e.currentTrackLyrics),100),t.appendChild(r),t.appendChild(l),t.appendChild(f),m.innerHTML="",m.appendChild(t)}else{const t=document.createElement("div");t.className="track-list",e.tracks.forEach((r,c)=>{const i=document.createElement("div");i.className="track-row",r.id===e.playingFileId&&i.classList.add("active");const s=r.name.split(".").pop()?.toUpperCase()||"AUDIO",{cleanName:l}=L(r.name),d=e.durationCache[r.id]||"--:--";i.innerHTML=`
          <div class="track-left">
              <div class="track-num">${c+1}</div>
              <div class="track-info">
                  <div class="track-name">${l}</div>
              </div>
          </div>
          <div class="track-right">
              <span class="track-tech tech-ext">${s}</span>
              <span class="track-tech track-duration" data-index="${c}">${d}</span>
          </div>
      `,i.onclick=()=>h(c),t.appendChild(i),e.durationCache[r.id]||q(r.id,c)}),m.innerHTML="",m.appendChild(t)}}function ve(){if(!y||!e.playlist.length||!o.duration||!isFinite(o.duration))return;const n=e.currentIndex+1;if(n>=e.playlist.length)return;const t=e.playlist[n];if(S===t.id)return;const r=o.duration/2,c=()=>{o.duration&&o.currentTime>=r&&(o.removeEventListener("timeupdate",c),Le(t))};o.addEventListener("timeupdate",c)}async function Le(n){if(y)try{const t=await fetch(`https://www.googleapis.com/drive/v3/files/${n.id}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Accept:"audio/*"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=await t.blob(),c=URL.createObjectURL(r);y.src=c,S=n.id,y.load()}catch(t){console.error("Preload failed",t),S=null}}async function h(n,t=0){if(e.isLoadingTrack)return;e.isLoadingTrack=!0,e.currentIndex=n,e.playlist=e.tracks;const r=e.playlist[n];e.playingFileId=r.id,e.currentAlbum&&(e.playingAlbumId=e.currentAlbum.id,await K(e.currentAlbum.id)?me(e.currentAlbum.id):ye(),R.style.display==="none"&&C()),U(),B.innerText="LOADING...",w.innerText=e.currentAlbum?e.currentAlbum.name.toUpperCase():"UNKNOWN";const c=e.currentAlbum&&e.covers[e.currentAlbum.id];c?H(k,c):k.src=A,e.blobUrl&&(URL.revokeObjectURL(e.blobUrl),e.blobUrl=null);const i=y&&S===r.id;try{if(i&&y)o.src=y.src,o.load();else{const s=await fetch(`https://www.googleapis.com/drive/v3/files/${r.id}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Accept:"audio/*"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const l=await s.blob(),d=URL.createObjectURL(l);e.blobUrl=d,o.src=d,o.load()}await new Promise((s,l)=>{o.oncanplaythrough=s,o.onerror=l,setTimeout(l,1e4)}),await o.play(),e.isPlaying=!0,e.isLoadingTrack=!1,N();const{cleanName:a}=L(r.name);B.innerText=a.toUpperCase(),$.style.display="block",le(r.name).then(s=>{e.currentTrackLyrics=s,document.querySelector(".lyrics-content")&&_(s),e.lyricsCurtainOpen&&z(s)}).catch(s=>{console.error("Failed to load lyrics:",s),e.currentTrackLyrics={plain:null,synced:null}}),ve()}catch(a){if(console.error("Playback Error:",a),e.isLoadingTrack=!1,t<2){setTimeout(()=>h(n,t+1),1e3);return}B.innerText="ERROR PLAYING",a.message?.includes("403")||a.message?.includes("401")?w.innerText="TOKEN EXPIRED - RESET":a.name==="NotSupportedError"?w.innerText="FORMAT NOT SUPPORTED":w.innerText="PLAYBACK FAILED - TAP NEXT"}if("mediaSession"in navigator){const{cleanName:a}=L(r.name);navigator.mediaSession.metadata=new window.MediaMetadata({title:a,artist:e.currentAlbum?.name||"Unknown",artwork:[{src:k.src,sizes:"512x512",type:"image/jpeg"}]}),navigator.mediaSession.setActionHandler("play",()=>{o.play(),e.isPlaying=!0,N()}),navigator.mediaSession.setActionHandler("pause",()=>{o.pause(),e.isPlaying=!1,N()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{e.currentIndex>0&&h(e.currentIndex-1)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{e.currentIndex<e.playlist.length-1&&h(e.currentIndex+1)})}}function N(){b.textContent=e.isPlaying?"||":"▶"}b.onclick=()=>{o.paused?(o.play(),e.isPlaying=!0):(o.pause(),e.isPlaying=!1),N()};Z.onclick=()=>{e.currentIndex<e.playlist.length-1&&h(e.currentIndex+1)};ee.onclick=()=>{e.currentIndex>0&&h(e.currentIndex-1)};o.ontimeupdate=()=>{if(!o.duration)return;const n=o.currentTime/o.duration*100;re.style.width=`${n}%`,de(o.currentTime)};o.onended=()=>{e.currentIndex<e.playlist.length-1&&h(e.currentIndex+1)};o.onerror=n=>{console.error("Audio element error:",n),e.isLoadingTrack=!1,e.isPlaying&&(B.innerText="PLAYBACK ERROR",w.innerText="SKIPPING...",setTimeout(()=>{e.currentIndex<e.playlist.length-1&&h(e.currentIndex+1)},1500))};te.onclick=n=>{const t=ne.getBoundingClientRect(),r=(n.clientX-t.left)/t.width;o.duration&&isFinite(o.duration)&&(o.currentTime=r*o.duration)};fe();
