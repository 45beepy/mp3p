(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))c(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function o(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(t){if(t.ep)return;t.ep=!0;const a=o(t);fetch(t.href,a)}})();const _="AIzaSyD53qoAMqp4Wu9nHSyaBbCzUn1j0gYK5Cw",z="957252189604-cfmbh7s2rjbpbql8rcsrlc3bpu6m2cq5.apps.googleusercontent.com",G="https://www.googleapis.com/auth/drive.readonly",S="mp3p_music",A="https://i.pinimg.com/1200x/4a/86/34/4a86344f69940e6b166c0bcbde36c3bc.jpg",P="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";let e={token:sessionStorage.getItem("g_token"),rootId:null,albums:[],tracks:[],covers:{},trackCache:{},coverBlobCache:{},durationCache:{},albumColors:{},albumLogos:{},lyricsCache:{},syncedLyricsCache:{},playlist:[],currentIndex:-1,currentAlbum:null,playingFileId:null,playingAlbumId:null,isPlaying:!1,blobUrl:null,isLoadingTrack:!1,currentLyrics:[],currentLyricIndex:-1,searchQuery:""};const Y=document.querySelector("#app");Y.innerHTML=`
  <header id="main-header">
    <div class="header-left">
      <button id="back-btn" class="secondary" style="display:none;">BACK</button>
      <h1 id="page-title">MP3P</h1>
    </div>
    <div class="header-center">
      <div id="search-container" style="display:none;">
        <input type="text" id="search-input" placeholder="Search albums..." />
        <button id="clear-search">✕</button>
      </div>
    </div>
    <div class="header-right">
        <button id="search-btn" title="Search Albums">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
        <button id="auth-btn">SYNC</button>
    </div>
  </header>
  
  <div id="main-view">
    <div style="padding:50px; text-align:center; color:#666; font-weight:700;">
      TAP <span style="color:#000; background:var(--yellow); padding:2px 6px;">SYNC</span> TO LOAD LIBRARY<br><br>
      (READING FOLDER: "${S}")
    </div>
  </div>

  <div id="player-bar">
    <div class="p-art-box">
      <img id="p-art" class="p-art" src="${P}">
    </div>

    <div class="p-center">
      <div class="p-track-info">
        <span id="p-title" class="p-title">NOT PLAYING</span>
        <span id="p-artist" class="p-artist">SELECT A TRACK</span>
      </div>
      <div class="p-scrubber" id="p-scrubber">
        <div class="p-bar-bg" id="p-bar-bg">
          <div class="p-bar-fill" id="p-bar-fill"></div>
        </div>
      </div>
    </div>

    <div class="p-controls">
      <button class="ctrl-btn" id="btn-prev">⏮</button>
      <button class="ctrl-btn play-btn" id="btn-play">▶</button>
      <button class="ctrl-btn" id="btn-next">⏭</button>
    </div>
  </div>
  
  <audio id="audio-engine"></audio>
`;const D=document.getElementById("main-header"),y=document.getElementById("main-view"),$=document.getElementById("back-btn"),p=document.getElementById("page-title"),u=document.getElementById("audio-engine"),x=document.getElementById("p-title"),C=document.getElementById("p-artist"),k=document.getElementById("p-art"),h=document.getElementById("btn-play"),Q=document.getElementById("btn-next"),V=document.getElementById("btn-prev"),W=document.getElementById("p-scrubber"),X=document.getElementById("p-bar-bg"),J=document.getElementById("p-bar-fill"),Z=document.getElementById("search-btn"),w=document.getElementById("search-container"),T=document.getElementById("search-input"),ee=document.getElementById("clear-search");k.onerror=()=>{k.src!==A&&(k.src=A)};Z.onclick=()=>{const r=w.style.display!=="none";w.style.display=r?"none":"flex",r?(e.searchQuery="",T.value="",L()):T.focus()};T.oninput=r=>{e.searchQuery=r.target.value.toLowerCase(),L()};ee.onclick=()=>{e.searchQuery="",T.value="",w.style.display="none",L()};function v(r){const n=r.replace(/\.[^/.]+$/,""),o=[/^(\d+)\.\s*/,/^(\d+)\s*-\s*/,/^(\d+)_\s*/,/^(\d+)\s+/];for(const c of o){const t=n.match(c);if(t){const a=parseInt(t[1],10),i=n.replace(c,"").trim();return{number:a,cleanName:i}}}return{number:999,cleanName:n}}function te(r){const n=r.split(`
`),o=[];for(const c of n){const t=c.match(/^\[(\d+):(\d+)\.(\d+)\](.*)$/);if(t){const a=parseInt(t[1],10),i=parseInt(t[2],10),l=parseInt(t[3],10),s=t[4].trim(),d=a*60+i+l/100;s.length>0&&o.push({time:d,text:s})}}return o}async function F(r){if(e.albumColors[r])return e.albumColors[r];try{const n=await gapi.client.drive.files.list({q:`name = 'colors.txt' and '${r}' in parents and trashed = false`,fields:"files(id)",pageSize:1});if(!n.result.files||n.result.files.length===0)return null;const o=n.result.files[0].id,c=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!c.ok)return null;const t=await c.text(),a=t.match(/font:\s*([#\w]+)/i),i=t.match(/line:\s*([#\w]+)/i),l=t.match(/titleBg:\s*([#\w]+)/i),s=t.match(/titleText:\s*([#\w]+)/i),d=t.match(/logo:\s*([^\r\n]+)/i);if(a&&i&&l&&s){const m={font:a[1].trim(),line:i[1].trim(),titleBg:l[1].trim(),titleText:s[1].trim(),logo:d?d[1].trim():void 0};return e.albumColors[r]=m,m.logo&&await ne(r,m.logo),m}return null}catch(n){return console.error("Error loading album colors:",n),null}}async function ne(r,n){try{const o=await gapi.client.drive.files.list({q:`name = '${n}' and '${r}' in parents and trashed = false`,fields:"files(id)",pageSize:1});if(!o.result.files||o.result.files.length===0)return;const c=o.result.files[0].id,t=await fetch(`https://www.googleapis.com/drive/v3/files/${c}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!t.ok)return;const a=await t.blob(),i=URL.createObjectURL(a);e.albumLogos[r]=i}catch(o){console.error("Error loading album logo:",o)}}async function re(r,n,o){const c=`${n}-${o}-${r}`;if(e.syncedLyricsCache[c])return console.log("Synced lyrics found in cache"),{plain:null,synced:e.syncedLyricsCache[c]};if(e.lyricsCache[c])return console.log("Plain lyrics found in cache"),{plain:e.lyricsCache[c],synced:null};try{console.log(`Searching lrclib for: ${r} (Album: ${o})`);const t=`https://lrclib.net/api/search?track_name=${encodeURIComponent(r)}`,a=await fetch(t,{headers:{"User-Agent":"MP3P Music Player v1.0"}});if(!a.ok)return console.log("Search failed on lrclib"),{plain:null,synced:null};const i=await a.json();if(!i||i.length===0)return console.log("No results found"),{plain:null,synced:null};let l=i[0];for(const s of i)if(s.albumName&&o&&s.albumName.toLowerCase().includes(o.toLowerCase())){l=s,console.log(`Found album match: ${s.artistName} - ${s.trackName} (${s.albumName})`);break}if(l===i[0]){for(const s of i)if(s.artistName&&o&&s.artistName.toLowerCase().includes(o.toLowerCase())){l=s,console.log(`Found artist match: ${s.artistName} - ${s.trackName}`);break}}if(console.log(`Using: ${l.artistName} - ${l.trackName} (${l.albumName||"No album"})`),l.syncedLyrics){console.log("Synced lyrics found!");const s=te(l.syncedLyrics);return e.syncedLyricsCache[c]=s,{plain:null,synced:s}}else if(l.plainLyrics)return console.log("Plain lyrics found"),e.lyricsCache[c]=l.plainLyrics,{plain:l.plainLyrics,synced:null};return{plain:null,synced:null}}catch(t){return console.error("Error fetching lyrics from lrclib:",t),{plain:null,synced:null}}}async function oe(r){if(!e.currentAlbum)return console.log("No current album"),{plain:null,synced:null};const{cleanName:n}=v(r),o=e.currentAlbum.name,c=e.currentAlbum.name;return await re(n,o,c)}function O(r){const n=document.querySelector(".lyrics-content");if(n)if(r.synced&&r.synced.length>0){e.currentLyrics=r.synced,e.currentLyricIndex=-1;const o=r.synced.map((c,t)=>{const a=c.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return`<p class="lyric-line" data-index="${t}" data-time="${c.time}">${a}</p>`}).join("");n.innerHTML=o}else if(r.plain){e.currentLyrics=[],e.currentLyricIndex=-1;const c=r.plain.split(`
`).map(t=>{const a=t.trim();return a===""?"<p><br></p>":`<p>${a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>`}).join("");n.innerHTML=c}else n.innerHTML='<p class="lyrics-placeholder">No lyrics available for this track</p>'}function ce(r){if(e.currentLyrics.length===0)return;let n=-1;for(let t=e.currentLyrics.length-1;t>=0;t--)if(r>=e.currentLyrics[t].time){n=t;break}if(n===e.currentLyricIndex)return;e.currentLyricIndex=n;const o=document.querySelector(".lyrics-content");if(!o)return;o.querySelectorAll(".lyric-line").forEach((t,a)=>{a===n?(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):t.classList.remove("active")})}function ae(r){const n=e.albumColors[r];document.querySelectorAll(".album-title.playing").forEach(o=>{const c=o;n?(c.style.color=n.font,c.style.borderBottomColor=n.line):(c.style.color="",c.style.borderBottomColor="")})}function se(r){const n=e.albumColors[r],o=e.albumLogos[r];n?(p.style.backgroundColor=n.titleBg,p.style.color=n.titleText,o?(p.classList.add("has-logo"),p.style.backgroundImage=`url("${o}")`,p.setAttribute("aria-label",p.textContent||"")):(p.classList.remove("has-logo"),p.style.backgroundImage="")):(p.classList.remove("has-logo"),p.style.backgroundColor="",p.style.color="",p.style.backgroundImage="")}function ie(r){const n=e.albumColors[r];n?(h.style.backgroundColor=n.font,h.style.color=n.titleText):(h.style.backgroundColor="",h.style.color="")}function q(){p.classList.remove("has-logo"),p.style.backgroundColor="",p.style.color="",p.style.backgroundImage=""}function le(){h.style.backgroundColor="",h.style.color=""}async function H(r,n){if(e.durationCache[r]){const o=document.querySelector(`[data-index="${n}"]`);o&&(o.textContent=e.durationCache[r]);return}try{const o=await fetch(`https://www.googleapis.com/drive/v3/files/${r}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Range:"bytes=0-204800"}});if(!o.ok)return;const c=await o.blob(),t=URL.createObjectURL(c),a=new Audio(t);await new Promise((i,l)=>{const s=setTimeout(()=>{a.removeEventListener("loadedmetadata",d),a.removeEventListener("error",m),URL.revokeObjectURL(t),l(new Error("Timeout"))},5e3),d=()=>{clearTimeout(s);const g=a.duration;if(g&&isFinite(g)){const b=Math.floor(g/60),M=Math.floor(g%60),E=`${b}:${M.toString().padStart(2,"0")}`;e.durationCache[r]=E;const I=document.querySelector(`[data-index="${n}"]`);I&&(I.textContent=E)}URL.revokeObjectURL(t),i()},m=()=>{clearTimeout(s),URL.revokeObjectURL(t),l(new Error("Load error"))};a.addEventListener("loadedmetadata",d),a.addEventListener("error",m)})}catch(o){console.error(`Failed to load duration for file ${r}:`,o)}}function de(){const r=document.createElement("script");r.src="https://accounts.google.com/gsi/client",r.onload=pe,document.body.append(r);const n=document.createElement("script");n.src="https://apis.google.com/js/api.js",n.onload=()=>gapi.load("client",ue),document.body.append(n)}async function ue(){await gapi.client.init({apiKey:_,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),e.token&&j()}function pe(){const r=google.accounts.oauth2.initTokenClient({client_id:z,scope:G,callback:n=>{n.error||(e.token=n.access_token,sessionStorage.setItem("g_token",n.access_token),j())}});document.getElementById("auth-btn").onclick=()=>r.requestAccessToken({prompt:""}),$.onclick=()=>{w.style.display="none",e.searchQuery="",T.value="",q(),L()}}async function B(r,n){let o=[],c=null;do{const t=await gapi.client.drive.files.list({q:r,fields:`nextPageToken, files(${n})`,pageSize:1e3,pageToken:c});t.result.files&&(o=o.concat(t.result.files)),c=t.result.nextPageToken}while(c);return o}async function U(r,n){if(e.coverBlobCache[n]){r.src=e.coverBlobCache[n];return}try{const o=await fetch(`https://www.googleapis.com/drive/v3/files/${n}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!o.ok)throw new Error;const c=await o.blob(),t=URL.createObjectURL(c);e.coverBlobCache[n]=t,r.src=t}catch{r.src=A}}async function j(){if(e.token){gapi.client.setToken({access_token:e.token}),e.trackCache={},e.coverBlobCache={};try{y.innerHTML=`<div style="text-align:center; padding:50px; color:#666; font-weight:700;">SCANNING "${S}"...</div>`;const r=await gapi.client.drive.files.list({pageSize:1,fields:"files(id)",q:`name = '${S}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`});if(e.rootId=r.result.files?.[0]?.id,!e.rootId){y.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow); font-weight:700;">FOLDER NOT FOUND</div>';return}e.albums=await B(`'${e.rootId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,"id, name");const n=await B("name = 'folder.jpg' and trashed = false","id, parents");e.covers={},n.forEach(o=>{o.parents?.[0]&&(e.covers[o.parents[0]]=o.id)}),L()}catch{y.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow);">CONNECTION FAILED<br>TRY RESET</div>'}}}function L(){if($.style.display="none",D.classList.remove("album-mode"),p.innerText="MP3P",e.albums.length===0){y.innerHTML='<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS FOUND</div>';return}const r=e.searchQuery?e.albums.filter(o=>o.name.toLowerCase().includes(e.searchQuery)):e.albums;if(r.length===0){y.innerHTML=`<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS MATCH "${e.searchQuery}"</div>`;return}const n=document.createElement("div");n.className="grid",r.forEach(o=>{const c=e.covers[o.id],t=document.createElement("div");t.className="album-card";const a=o.id===e.playingAlbumId?"album-title playing":"album-title";t.innerHTML=`<img class="album-cover" src="${P}"><div class="${a}">${o.name}</div>`;const i=t.querySelector("img");c?U(i,c):i.src=A,t.onclick=()=>me(o),n.appendChild(t)}),y.innerHTML="",y.appendChild(n),e.playingAlbumId&&ae(e.playingAlbumId)}async function me(r){if(e.currentAlbum=r,$.style.display="block",D.classList.add("album-mode"),p.innerText=r.name.toUpperCase(),w.style.display="none",await F(r.id)?se(r.id):q(),e.trackCache[r.id]){e.tracks=e.trackCache[r.id],R();return}y.innerHTML='<div style="text-align:center; padding:50px; color:#666; font-weight:700;">LOADING TRACKS...</div>';try{e.tracks=await B(`'${r.id}' in parents and (mimeType contains 'audio/') and trashed = false`,"id, name, mimeType, size"),e.tracks.sort((o,c)=>{const t=v(o.name),a=v(c.name);return t.number-a.number}),e.trackCache[r.id]=e.tracks,R()}catch{y.innerHTML="ERROR LOADING TRACKS"}}function R(){if(window.innerWidth>768){const n=document.createElement("div");n.className="album-view-desktop";const o=document.createElement("div");o.className="album-left";const c=document.createElement("div");c.className="album-art-large";const t=document.createElement("img");t.src=P;const a=e.currentAlbum&&e.covers[e.currentAlbum.id];a?U(t,a):t.src=A,c.appendChild(t);const i=document.createElement("div");i.className="album-info",i.innerHTML=`
      <h2>${e.currentAlbum?.name||"Unknown Album"}</h2>
      <p class="track-count">${e.tracks.length} tracks</p>
    `,o.appendChild(c),o.appendChild(i);const l=document.createElement("div");l.className="album-middle";const s=document.createElement("div");s.className="track-list-compact",e.tracks.forEach((m,g)=>{const b=document.createElement("div");b.className="track-row",m.id===e.playingFileId&&b.classList.add("active");const E=m.name.split(".").pop()?.toUpperCase()||"AUDIO",{cleanName:I}=v(m.name),K=e.durationCache[m.id]||"--:--";b.innerHTML=`
          <div class="track-left">
              <div class="track-num">${g+1}</div>
              <div class="track-info">
                  <div class="track-name">${I}</div>
              </div>
          </div>
          <div class="track-right">
              <span class="track-tech tech-ext">${E}</span>
              <span class="track-tech track-duration" data-index="${g}">${K}</span>
          </div>
      `,b.onclick=()=>f(g),s.appendChild(b),e.durationCache[m.id]||H(m.id,g)}),l.appendChild(s);const d=document.createElement("div");d.className="album-right",d.id="lyrics-panel",d.innerHTML=`
      <div class="lyrics-header">LYRICS</div>
      <div class="lyrics-content">
        <p class="lyrics-placeholder">Select a track to view lyrics</p>
      </div>
    `,n.appendChild(o),n.appendChild(l),n.appendChild(d),y.innerHTML="",y.appendChild(n)}else{const n=document.createElement("div");n.className="track-list",e.tracks.forEach((o,c)=>{const t=document.createElement("div");t.className="track-row",o.id===e.playingFileId&&t.classList.add("active");const i=o.name.split(".").pop()?.toUpperCase()||"AUDIO",{cleanName:l}=v(o.name),s=e.durationCache[o.id]||"--:--";t.innerHTML=`
          <div class="track-left">
              <div class="track-num">${c+1}</div>
              <div class="track-info">
                  <div class="track-name">${l}</div>
              </div>
          </div>
          <div class="track-right">
              <span class="track-tech tech-ext">${i}</span>
              <span class="track-tech track-duration" data-index="${c}">${s}</span>
          </div>
      `,t.onclick=()=>f(c),n.appendChild(t),e.durationCache[o.id]||H(o.id,c)}),y.innerHTML="",y.appendChild(n)}}async function f(r,n=0){if(e.isLoadingTrack){console.log("Already loading a track, skipping...");return}e.isLoadingTrack=!0,e.currentIndex=r,e.playlist=e.tracks;const o=e.playlist[r];e.playingFileId=o.id,e.currentAlbum&&(e.playingAlbumId=e.currentAlbum.id,await F(e.currentAlbum.id)?ie(e.currentAlbum.id):le(),$.style.display==="none"&&L()),R(),x.innerText="LOADING...",C.innerText=e.currentAlbum?e.currentAlbum.name.toUpperCase():"UNKNOWN";const c=e.currentAlbum&&e.covers[e.currentAlbum.id];c?U(k,c):k.src=A,e.blobUrl&&(URL.revokeObjectURL(e.blobUrl),e.blobUrl=null);try{const t=await fetch(`https://www.googleapis.com/drive/v3/files/${o.id}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Accept:"audio/*"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const a=await t.blob(),i=URL.createObjectURL(a);e.blobUrl=i,u.src=i,u.load(),await new Promise((s,d)=>{u.oncanplaythrough=s,u.onerror=d,setTimeout(d,1e4)}),await u.play(),e.isPlaying=!0,e.isLoadingTrack=!1,N();const{cleanName:l}=v(o.name);if(x.innerText=l.toUpperCase(),window.innerWidth>768){const s=document.querySelector(".lyrics-content");s&&(s.innerHTML='<p class="lyrics-placeholder">Searching lyrics...</p>',oe(o.name).then(d=>{O(d)}).catch(d=>{console.error("Failed to load lyrics:",d),O({plain:null,synced:null})}))}}catch(t){if(console.error("Playback Error:",t),e.isLoadingTrack=!1,n<2){console.log(`Retrying playback... (${n+1}/2)`),setTimeout(()=>f(r,n+1),1e3);return}x.innerText="ERROR PLAYING",t.message?.includes("403")||t.message?.includes("401")?C.innerText="TOKEN EXPIRED - RESET":t.name==="NotSupportedError"?C.innerText="FORMAT NOT SUPPORTED":C.innerText="PLAYBACK FAILED - TAP NEXT"}if("mediaSession"in navigator){const{cleanName:t}=v(o.name);navigator.mediaSession.metadata=new MediaMetadata({title:t,artist:e.currentAlbum?.name||"Unknown",artwork:[{src:k.src,sizes:"512x512",type:"image/jpeg"}]}),navigator.mediaSession.setActionHandler("play",()=>{u.play(),e.isPlaying=!0,N()}),navigator.mediaSession.setActionHandler("pause",()=>{u.pause(),e.isPlaying=!1,N()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{e.currentIndex>0&&f(e.currentIndex-1)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{e.currentIndex<e.playlist.length-1&&f(e.currentIndex+1)})}}function N(){h.textContent=e.isPlaying?"||":"▶"}h.onclick=()=>{u.paused?(u.play(),e.isPlaying=!0):(u.pause(),e.isPlaying=!1),N()};Q.onclick=()=>{e.currentIndex<e.playlist.length-1&&f(e.currentIndex+1)};V.onclick=()=>{e.currentIndex>0&&f(e.currentIndex-1)};u.ontimeupdate=()=>{if(!u.duration)return;const r=u.currentTime/u.duration*100;J.style.width=`${r}%`,ce(u.currentTime)};u.onended=()=>{e.currentIndex<e.playlist.length-1&&f(e.currentIndex+1)};u.onerror=r=>{console.error("Audio element error:",r),e.isLoadingTrack=!1,e.isPlaying&&(x.innerText="PLAYBACK ERROR",C.innerText="SKIPPING...",setTimeout(()=>{e.currentIndex<e.playlist.length-1&&f(e.currentIndex+1)},1500))};W.onclick=r=>{const n=X.getBoundingClientRect(),o=(r.clientX-n.left)/n.width;u.currentTime=o*u.duration};de();
