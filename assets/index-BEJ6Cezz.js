(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();const M="AIzaSyD53qoAMqp4Wu9nHSyaBbCzUn1j0gYK5Cw",U="957252189604-cfmbh7s2rjbpbql8rcsrlc3bpu6m2cq5.apps.googleusercontent.com",D="https://www.googleapis.com/auth/drive.readonly",E="mp3p_music",v="https://i.pinimg.com/1200x/4a/86/34/4a86344f69940e6b166c0bcbde36c3bc.jpg",N="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";let e={token:sessionStorage.getItem("g_token"),rootId:null,albums:[],tracks:[],covers:{},trackCache:{},coverBlobCache:{},durationCache:{},albumColors:{},playlist:[],currentIndex:-1,currentAlbum:null,playingFileId:null,playingAlbumId:null,isPlaying:!1,blobUrl:null,isLoadingTrack:!1,searchQuery:""};const H=document.querySelector("#app");H.innerHTML=`
  <header id="main-header">
    <div class="header-left">
      <button id="back-btn" class="secondary" style="display:none;">BACK</button>
      <h1 id="page-title">MP3P</h1>
    </div>
    <div class="header-center">
      <div id="search-container" style="display:none;">
        <input type="text" id="search-input" placeholder="Search albums..." />
        <button id="clear-search">✕</button>
      </div>
    </div>
    <div class="header-right">
        <button id="search-btn" title="Search Albums">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
        <button id="auth-btn">SYNC</button>
    </div>
  </header>
  
  <div id="main-view">
    <div style="padding:50px; text-align:center; color:#666; font-weight:700;">
      TAP <span style="color:#000; background:var(--yellow); padding:2px 6px;">SYNC</span> TO LOAD LIBRARY<br><br>
      (READING FOLDER: "${E}")
    </div>
  </div>

  <div id="player-bar">
    <div class="p-art-box">
      <img id="p-art" class="p-art" src="${N}">
    </div>

    <div class="p-center">
      <div class="p-track-info">
        <span id="p-title" class="p-title">NOT PLAYING</span>
        <span id="p-artist" class="p-artist">SELECT A TRACK</span>
      </div>
      <div class="p-scrubber" id="p-scrubber">
        <div class="p-bar-bg" id="p-bar-bg">
          <div class="p-bar-fill" id="p-bar-fill"></div>
        </div>
      </div>
    </div>

    <div class="p-controls">
      <button class="ctrl-btn" id="btn-prev">⏮</button>
      <button class="ctrl-btn play-btn" id="btn-play">▶</button>
      <button class="ctrl-btn" id="btn-next">⏭</button>
    </div>
  </div>
  
  <audio id="audio-engine"></audio>
`;const S=document.getElementById("main-header"),l=document.getElementById("main-view"),I=document.getElementById("back-btn"),p=document.getElementById("page-title"),c=document.getElementById("audio-engine"),C=document.getElementById("p-title"),h=document.getElementById("p-artist"),b=document.getElementById("p-art"),m=document.getElementById("btn-play"),F=document.getElementById("btn-next"),q=document.getElementById("btn-prev"),K=document.getElementById("p-scrubber"),_=document.getElementById("p-bar-bg"),G=document.getElementById("p-bar-fill"),j=document.getElementById("search-btn"),A=document.getElementById("search-container"),k=document.getElementById("search-input"),z=document.getElementById("clear-search");b.onerror=()=>{b.src!==v&&(b.src=v)};j.onclick=()=>{const n=A.style.display!=="none";A.style.display=n?"none":"flex",n?(e.searchQuery="",k.value="",f()):k.focus()};k.oninput=n=>{e.searchQuery=n.target.value.toLowerCase(),f()};z.onclick=()=>{e.searchQuery="",k.value="",A.style.display="none",f()};function T(n){const t=n.replace(/\.[^/.]+$/,""),o=[/^(\d+)\.\s*/,/^(\d+)\s*-\s*/,/^(\d+)_\s*/,/^(\d+)\s+/];for(const i of o){const r=t.match(i);if(r){const a=parseInt(r[1],10),s=t.replace(i,"").trim();return{number:a,cleanName:s}}}return{number:999,cleanName:t}}async function R(n){if(e.albumColors[n])return e.albumColors[n];try{const t=await gapi.client.drive.files.list({q:`name = 'colors.txt' and '${n}' in parents and trashed = false`,fields:"files(id)",pageSize:1});if(!t.result.files||t.result.files.length===0)return null;const o=t.result.files[0].id,i=await fetch(`https://www.googleapis.com/drive/v3/files/${o}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!i.ok)return null;const r=await i.text(),a=r.match(/font:\s*([#\w]+)/i),s=r.match(/line:\s*([#\w]+)/i),d=r.match(/titleBg:\s*([#\w]+)/i),y=r.match(/titleText:\s*([#\w]+)/i);if(a&&s&&d&&y){const u={font:a[1].trim(),line:s[1].trim(),titleBg:d[1].trim(),titleText:y[1].trim()};return e.albumColors[n]=u,u}return null}catch(t){return console.error("Error loading album colors:",t),null}}function Y(n){const t=e.albumColors[n];document.querySelectorAll(".album-title.playing").forEach(o=>{const i=o;t?(i.style.color=t.font,i.style.borderBottomColor=t.line):(i.style.color="",i.style.borderBottomColor="")})}function Q(n){const t=e.albumColors[n];t?(p.style.backgroundColor=t.titleBg,p.style.color=t.titleText):(p.style.backgroundColor="",p.style.color="")}function V(n){const t=e.albumColors[n];t?(m.style.backgroundColor=t.font,m.style.color=t.titleText):(m.style.backgroundColor="",m.style.color="")}function P(){p.style.backgroundColor="",p.style.color=""}function W(){m.style.backgroundColor="",m.style.color=""}async function X(n,t){if(e.durationCache[n]){const o=document.querySelector(`[data-index="${t}"]`);o&&(o.textContent=e.durationCache[n]);return}try{const o=await fetch(`https://www.googleapis.com/drive/v3/files/${n}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Range:"bytes=0-50000"}});if(!o.ok)return;const i=await o.blob(),r=URL.createObjectURL(i),a=new Audio(r);a.addEventListener("loadedmetadata",()=>{const s=a.duration;if(s&&isFinite(s)){const d=Math.floor(s/60),y=Math.floor(s%60),u=`${d}:${y.toString().padStart(2,"0")}`;e.durationCache[n]=u;const B=document.querySelector(`[data-index="${t}"]`);B&&(B.textContent=u)}URL.revokeObjectURL(r)})}catch{}}function J(){const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.onload=ee,document.body.append(n);const t=document.createElement("script");t.src="https://apis.google.com/js/api.js",t.onload=()=>gapi.load("client",Z),document.body.append(t)}async function Z(){await gapi.client.init({apiKey:M,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),e.token&&$()}function ee(){const n=google.accounts.oauth2.initTokenClient({client_id:U,scope:D,callback:t=>{t.error||(e.token=t.access_token,sessionStorage.setItem("g_token",t.access_token),$())}});document.getElementById("auth-btn").onclick=()=>n.requestAccessToken({prompt:""}),I.onclick=()=>{A.style.display="none",e.searchQuery="",k.value="",P(),f()}}async function x(n,t){let o=[],i=null;do{const r=await gapi.client.drive.files.list({q:n,fields:`nextPageToken, files(${t})`,pageSize:1e3,pageToken:i});r.result.files&&(o=o.concat(r.result.files)),i=r.result.nextPageToken}while(i);return o}async function O(n,t){if(e.coverBlobCache[t]){n.src=e.coverBlobCache[t];return}try{const o=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`}});if(!o.ok)throw new Error;const i=await o.blob(),r=URL.createObjectURL(i);e.coverBlobCache[t]=r,n.src=r}catch{n.src=v}}async function $(){if(e.token){gapi.client.setToken({access_token:e.token}),e.trackCache={},e.coverBlobCache={};try{l.innerHTML=`<div style="text-align:center; padding:50px; color:#666; font-weight:700;">SCANNING "${E}"...</div>`;const n=await gapi.client.drive.files.list({pageSize:1,fields:"files(id)",q:`name = '${E}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`});if(e.rootId=n.result.files?.[0]?.id,!e.rootId){l.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow); font-weight:700;">FOLDER NOT FOUND</div>';return}e.albums=await x(`'${e.rootId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,"id, name");const t=await x("name = 'folder.jpg' and trashed = false","id, parents");e.covers={},t.forEach(o=>{o.parents?.[0]&&(e.covers[o.parents[0]]=o.id)}),f()}catch{l.innerHTML='<div style="text-align:center; padding:50px; color:var(--yellow);">CONNECTION FAILED<br>TRY RESET</div>'}}}function f(){if(I.style.display="none",S.classList.remove("album-mode"),p.innerText="MP3P",e.albums.length===0){l.innerHTML='<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS FOUND</div>';return}const n=e.searchQuery?e.albums.filter(o=>o.name.toLowerCase().includes(e.searchQuery)):e.albums;if(n.length===0){l.innerHTML=`<div style="text-align:center; padding:50px; color:#666;">NO ALBUMS MATCH "${e.searchQuery}"</div>`;return}const t=document.createElement("div");t.className="grid",n.forEach(o=>{const i=e.covers[o.id],r=document.createElement("div");r.className="album-card";const a=o.id===e.playingAlbumId?"album-title playing":"album-title";r.innerHTML=`<img class="album-cover" src="${N}"><div class="${a}">${o.name}</div>`;const s=r.querySelector("img");i?O(s,i):s.src=v,r.onclick=()=>te(o),t.appendChild(r)}),l.innerHTML="",l.appendChild(t),e.playingAlbumId&&Y(e.playingAlbumId)}async function te(n){if(e.currentAlbum=n,I.style.display="block",S.classList.add("album-mode"),p.innerText=n.name.toUpperCase(),A.style.display="none",await R(n.id)?Q(n.id):P(),e.trackCache[n.id]){e.tracks=e.trackCache[n.id],L();return}l.innerHTML='<div style="text-align:center; padding:50px; color:#666; font-weight:700;">LOADING TRACKS...</div>';try{e.tracks=await x(`'${n.id}' in parents and (mimeType contains 'audio/') and trashed = false`,"id, name, mimeType, size"),e.tracks.sort((o,i)=>{const r=T(o.name),a=T(i.name);return r.number-a.number}),e.trackCache[n.id]=e.tracks,L()}catch{l.innerHTML="ERROR LOADING TRACKS"}}function L(){const n=document.createElement("div");n.className="track-list",e.tracks.forEach((t,o)=>{const i=document.createElement("div");i.className="track-row",t.id===e.playingFileId&&i.classList.add("active");const a=t.name.split(".").pop()?.toUpperCase()||"AUDIO",{cleanName:s}=T(t.name),d=e.durationCache[t.id]||"--:--";i.innerHTML=`
          <div class="track-left">
              <div class="track-num">${o+1}</div>
              <div class="track-info">
                  <div class="track-name">${s}</div>
              </div>
          </div>
          <div class="track-right">
              <span class="track-tech tech-ext">${a}</span>
              <span class="track-tech track-duration" data-index="${o}">${d}</span>
          </div>
      `,i.onclick=()=>g(o),n.appendChild(i),e.durationCache[t.id]||X(t.id,o)}),l.innerHTML="",l.appendChild(n)}async function g(n,t=0){if(e.isLoadingTrack){console.log("Already loading a track, skipping...");return}e.isLoadingTrack=!0,e.currentIndex=n,e.playlist=e.tracks;const o=e.playlist[n];e.playingFileId=o.id,e.currentAlbum&&(e.playingAlbumId=e.currentAlbum.id,await R(e.currentAlbum.id)?V(e.currentAlbum.id):W(),I.style.display==="none"&&f()),L(),C.innerText="LOADING...",h.innerText=e.currentAlbum?e.currentAlbum.name.toUpperCase():"UNKNOWN";const i=e.currentAlbum&&e.covers[e.currentAlbum.id];i?O(b,i):b.src=v,e.blobUrl&&(URL.revokeObjectURL(e.blobUrl),e.blobUrl=null);try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${o.id}?alt=media`,{headers:{Authorization:`Bearer ${e.token}`,Accept:"audio/*"}});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const a=await r.blob(),s=URL.createObjectURL(a);e.blobUrl=s,c.src=s,c.load(),await new Promise((y,u)=>{c.oncanplaythrough=y,c.onerror=u,setTimeout(u,1e4)}),await c.play(),e.isPlaying=!0,e.isLoadingTrack=!1,w();const{cleanName:d}=T(o.name);C.innerText=d.toUpperCase()}catch(r){if(console.error("Playback Error:",r),e.isLoadingTrack=!1,t<2){console.log(`Retrying playback... (${t+1}/2)`),setTimeout(()=>g(n,t+1),1e3);return}C.innerText="ERROR PLAYING",r.message?.includes("403")||r.message?.includes("401")?h.innerText="TOKEN EXPIRED - RESET":r.name==="NotSupportedError"?h.innerText="FORMAT NOT SUPPORTED":h.innerText="PLAYBACK FAILED - TAP NEXT"}if("mediaSession"in navigator){const{cleanName:r}=T(o.name);navigator.mediaSession.metadata=new MediaMetadata({title:r,artist:e.currentAlbum?.name||"Unknown",artwork:[{src:b.src,sizes:"512x512",type:"image/jpeg"}]}),navigator.mediaSession.setActionHandler("play",()=>{c.play(),e.isPlaying=!0,w()}),navigator.mediaSession.setActionHandler("pause",()=>{c.pause(),e.isPlaying=!1,w()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{e.currentIndex>0&&g(e.currentIndex-1)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{e.currentIndex<e.playlist.length-1&&g(e.currentIndex+1)})}}function w(){m.textContent=e.isPlaying?"||":"▶"}m.onclick=()=>{c.paused?(c.play(),e.isPlaying=!0):(c.pause(),e.isPlaying=!1),w()};F.onclick=()=>{e.currentIndex<e.playlist.length-1&&g(e.currentIndex+1)};q.onclick=()=>{e.currentIndex>0&&g(e.currentIndex-1)};c.ontimeupdate=()=>{if(!c.duration)return;const n=c.currentTime/c.duration*100;G.style.width=`${n}%`};c.onended=()=>{e.currentIndex<e.playlist.length-1&&g(e.currentIndex+1)};c.onerror=n=>{console.error("Audio element error:",n),e.isLoadingTrack=!1,e.isPlaying&&(C.innerText="PLAYBACK ERROR",h.innerText="SKIPPING...",setTimeout(()=>{e.currentIndex<e.playlist.length-1&&g(e.currentIndex+1)},1500))};K.onclick=n=>{const t=_.getBoundingClientRect(),o=(n.clientX-t.left)/t.width;c.currentTime=o*c.duration};J();
